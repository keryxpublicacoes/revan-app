<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Revan – Compra de Livro Impresso</title>
  <style>
    /* ... seu CSS INTEIRO exatamente igual ... */
    /* (não mexi no estilo, apenas no <script>) */
  </style>
</head>
<body>

  <div class="container">
    <div class="back-btn">
      <a href="/">← Início</a>
    </div>

    <div class="hero">
      <div class="image-capa">
        <img src="../static/capa_livro.jpg" alt="Capa do Livro">
      </div>
      <div class="right-col">
        <div class="info">
          <h1>COMPRA DE LIVRO IMPRESSO</h1>
          <h2>Valor unitário: R$ 59,70</h2>
          <p>Preencha seus dados, calcule o frete, faça o PIX e anexe o comprovante.</p>
          <div class="cta-text">Garanta já o seu exemplar e transforme sua história!</div>
        </div>
        <div class="image-mockup">
          <img src="../static/mockup_livro.png" alt="Mockup do Livro">
        </div>
      </div>
    </div>

    <form id="formulario" action="https://script.google.com/macros/s/AKfycbx_jVZf6hPHqg10xgfylug9z6_da-ECfaWy2SsaCYw3r5C4YC1Vqo01R8M7KhE3Wvv7/exec" method="POST">
      <input type="hidden" name="type" value="fisico">
      <input type="hidden" id="receipt" name="receipt">

      <input type="text" name="name" placeholder="Nome completo" required>
      <input type="email" name="email" placeholder="E-mail" required>
      <input type="text" name="whatsapp" placeholder="WhatsApp" required>
      <input type="text" name="street" placeholder="Logradouro" required>

      <div class="row">
        <input type="text" name="number" placeholder="Número" required>
        <input type="text" name="complement" placeholder="Complemento">
      </div>

      <input type="text" name="neighborhood" placeholder="Bairro" required>

      <div class="row">
        <input type="text" name="city" placeholder="Cidade" required>
        <input type="text" name="state" maxlength="2" placeholder="UF" required>
      </div>

      <input type="text" id="cep" name="cep" placeholder="00000-000" maxlength="9" required>
      <input type="text" id="shipping" name="shipping" placeholder="Frete" readonly>
      <input type="text" id="total" name="total" placeholder="Total (Livro + Frete)" readonly>

      <div class="pix-info">
        <p>Pagamento via PIX — <strong>RAP FORTE LTDA</strong></p>
        <p>Chave PIX (CNPJ): <strong>40.526.208/0001-63</strong></p>
        <img src="../static/qr_pix_fisico.jpg" alt="QR Code PIX">
        <label for="pix-code" style="display:block; margin:8px 0 4px; color:#fff;">Código PIX:</label>
        <textarea id="pix-code" readonly>00020126430014br.gov.bcb.pix0114405262080001630203Pix5204000053039865802BR5914RAP FORTE LTDA6010ABRE CAMPO622905256EKIqU8VmavjnLwvNGY91XVVi63041FB5</textarea>
        <button type="button" id="copy-btn">Copiar código PIX</button>
      </div>

      <input type="file" id="receipt-file" accept="image/*,.pdf" required>
      <input type="submit" value="Enviar Comprovante e Finalizar Pedido">
    </form>
  </div>

  <script>
    document.getElementById('cep').addEventListener('blur', async (e) => {
      const cep = e.target.value.replace(/\D/g, '');
      if (cep.length === 8) {
        try {
          const res = await fetch(`/calculate-shipping?cep=${cep}`);
          if (!res.ok) throw '';
          const { valor_frete } = await res.json();
          document.getElementById('shipping').value = 'R$ ' + valor_frete.toFixed(2).replace('.', ',');
          const total = 59.70 + valor_frete;
          document.getElementById('total').value = 'R$ ' + total.toFixed(2).replace('.', ',');
        } catch {
          alert('Não foi possível calcular o frete. Verifique o CEP.');
        }
      }
    });

    document.getElementById('copy-btn').addEventListener('click', () => {
      const txt = document.getElementById('pix-code');
      txt.select();
      document.execCommand('copy');
      alert('Código PIX copiado!');
    });

    // NOVO SCRIPT PARA CONVERTER COMPROVANTE
    document.getElementById('formulario').addEventListener('submit', async (e) => {
      e.preventDefault();

      const fileInput = document.getElementById('receipt-file');
      const file = fileInput.files[0];

      if (!file) {
        alert('Por favor, selecione o comprovante.');
        return;
      }

      const reader = new FileReader();
      reader.onload = async () => {
        document.getElementById('receipt').value = reader.result.split(',')[1];
        e.target.submit();
      };
      reader.readAsDataURL(file);
    });
  </script>

</body>
</html>
